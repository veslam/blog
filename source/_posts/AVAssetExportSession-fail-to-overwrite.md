---
title: AVAssetExportSession-fail-to-overwrite
date: 2016-08-04 13:23:12
tags: [coding, iOS, AVFoundation]
---
å…ˆä¸Šç»“è®ºï¼š
+ iOSåº”ç”¨åœ¨å¸è½½ä¹‹å‰ï¼Œæ²™ç›’è·¯å¾„æ˜¯ä¸å˜çš„ã€‚
+ __AVFoundation__é€šè¿‡__AVAssetExportSession__å†™æ–‡ä»¶åˆ°æ²™ç›’ä¸­æ—¶ï¼Œæ— æ³•è¦†ç›–å·²æœ‰æ–‡ä»¶ï¼Œä¼šå¤±è´¥ã€‚

---

ä¸‹é¢æ˜¯å¿ƒè·¯åŽ†ç¨‹ã€‚
ä»Žæ˜¨å¤©ä¸‹åˆï¼ŒAppå•æœºè¿è¡Œæ—¶æœ‰å¦‚ä¸‹è¡¨çŽ°ï¼š
1. æœ‰æ¦‚çŽ‡ä¼šåœ¨[å¤„ç†è§†é¢‘/å­˜å‚¨è§†é¢‘/æ’­æ”¾è§†é¢‘]è¿™ä¸ªè¿‡ç¨‹ä¸­çš„æŸä¸€æ­¥é—ªé€€ï¼Œå…·ä½“åœ¨å“ªä¸€æ­¥å½“æ—¶è¿˜æ²¡æœ‰ç¡®å®šã€‚
2. ä¸€æ—¦é—ªé€€ï¼Œä»¥åŽé‡å¯Appï¼Œå¿…å®šåœ¨ç›¸ä¼¼ä½ç½®é—ªé€€ã€‚ï¼ˆçŒœæµ‹æ˜¯åœ¨åŒä¸€æ­¥ï¼ŒåŽæ¥ç¡®è®¤çš„ç¡®æ˜¯ã€‚ï¼‰
3. Xcodeè¿žæœºè¿è¡Œï¼Œè™½ç„¶ä¹Ÿæœ‰æ¦‚çŽ‡åœ¨ç›¸ä¼¼ä½ç½®é—ªé€€ï¼Œä½†ä¸‹æ¬¡è¿è¡Œå°±æ²¡é—®é¢˜äº†å•Šã€‚ðŸ¤”

é¦–å…ˆæƒ³æ˜Žç™½çš„æ˜¯ç¬¬3ç‚¹ã€‚Xcodeè¿žæœºçš„æ¯æ¬¡è¿è¡Œï¼Œå…¶å®žç›¸å½“äºŽè¦†ç›–å®‰è£…ä¸€æ¬¡Appï¼Œæ‰€ä»¥å’Œå•æœºè·‘æ˜¯æœ‰åŒºåˆ«çš„ï¼ˆå…¶å®žå›žè¿‡å¤´æ¥çœ‹è¿™ä¹Ÿæ˜¯ä¸ªçº¿ç´¢ï¼Œé—ªé€€ä¸€å®šå’Œä¸¤è€…çš„åŒºåˆ«æœ‰å…³ï¼‰ã€‚

ä¹‹åŽæ²¡æœ‰å¤´ç»ªï¼Œå¸Œæœ›èƒ½å°½é‡ç¡®å®šé—ªé€€çš„ä»£ç ä½ç½®ã€‚Xcodeè¿žæœºæ—¶ä¼¼ä¹Žä¸èƒ½ä¸å®‰è£…åªé‡å¯Appï¼Œå•æœºè¿è¡Œä¸èƒ½æ‰“æ–­ç‚¹ï¼Œlogè¾“å‡ºä¹Ÿçœ‹ä¸åˆ°ï¼Œé‚£å°±åªå¥½æŠŠlogæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œçœ‹æ˜¾ç¤ºåˆ°é‚£ä¸€æ¡æ—¶é—ªé€€ã€‚å†™åˆ°ä¸€ä¸ªTextFieldé‡Œæ˜¾ç¤ºå‡ºæ¥ï¼ˆåªèƒ½æ˜¾ç¤ºæœ€æ–°ä¸€æ¡ï¼‰ã€‚
ç»è¿‡å¤šæ¬¡åœ¨ä»£ç é‡ŒæŒªåŠ¨è¾“å‡ºçš„ä½ç½®ï¼ŒåŸºæœ¬ç¡®å®šé—®é¢˜å‡ºåœ¨å­˜å‚¨è§†é¢‘è¿™ä¸€æ­¥ã€‚

é‚£ä¹ˆï¼Œè¦å­˜çš„æ–‡ä»¶è‚¯å®šæ˜¯å¥½çš„ï¼Œå­˜å‚¨å¤±è´¥æœ€å¤§çš„å¯èƒ½å°±æ˜¯ï¼Œæ–‡ä»¶åå·²å­˜åœ¨ä¸”è¦†ç›–å¤±è´¥ï¼Ÿ
æ²™ç›’tmpæ–‡ä»¶å¤¹è·¯å¾„æ ¼å¼æ˜¯ï¼š
>/var/mobile/Containers/Data/Application/440E4599-DAFF-4B57-AD79-759248479F1B/tmp/

æˆ‘çš„æ–‡ä»¶åæ ¼å¼æ˜¯A-B.mp4ï¼ŒAæ¥è‡ªæˆªå–æ²™ç›’è·¯å¾„é‡Œçš„16è¿›åˆ¶éƒ¨åˆ†ï¼ŒBæ˜¯ä»Ž0å¼€å§‹é€’å¢žçš„æ•´æ•°ï¼Œæ‰€ä»¥æ–‡ä»¶åæ˜¯ï¼š
>440E4599-DAFF-4B57-AD79-759248479F1B-0.mp4

ä¹‹æ‰€ä»¥è®¾è®¡å¾—è¿™ä¹ˆç®€å•ï¼Œæ˜¯å› ä¸ºæˆ‘è§‰å¾—æ—¢ç„¶æ¯æ¬¡è¿è¡Œï¼Œæ²™ç›’è·¯å¾„éƒ½ä¸ä¸€æ ·ï¼Œé‚£å¤šæ¬¡è¿è¡ŒAppçš„è§†é¢‘åç§°è‡ªç„¶ä¸å¯èƒ½ç›¸åŒï¼Œå› æ­¤åªéœ€è¦åŠ ä¸€ä¸ªåºå·åŽç¼€ï¼ŒåŒºåˆ†æœ¬æ¬¡è¿è¡Œç”Ÿæˆçš„æ–‡ä»¶ä»¬å°±è¡Œå•¦ã€‚ï¼ˆæ•™è®­ï¼Œè¿˜æ˜¯ä¸è¦å·æ‡’ï¼Œæœ€å¥½ç”¨NSDateç­‰èƒ½ä¿è¯è‡ªå·±å”¯ä¸€æ€§çš„ä¸œè¥¿ã€‚ï¼‰
éš¾é“ï¼Œå…¶å®žæ²™ç›’è·¯å¾„æ˜¯å›ºå®šçš„ï¼Ÿè€Œè¿žæœºè°ƒè¯•æ—¶ä¹‹æ‰€ä»¥æ¯æ¬¡è¿è¡Œæ˜¾ç¤ºæ²™ç›’è·¯å¾„éƒ½ä¸ä¸€æ ·ï¼Œæ˜¯å› ä¸ºé‡æ–°å®‰è£…çš„ç»“æžœï¼Ÿï¼Ÿï¼Ÿç»æµ‹è¯•ï¼ŒæžœçœŸï¼Œæ²™ç›’è·¯å¾„ä¸ä¼šå˜ã€‚â€¦â€¦

ä¹‹åŽçœ‹åˆ°è‡ªå·±å†™äº†å´ä¸€ç‚¹å°è±¡ä¹Ÿæ²¡æœ‰çš„ assert(exporter.error == nil); ä¸€å®šæ˜¯é—ªé€€åœ¨è¿™é‡Œå•¦ï¼Œä¹Ÿæ˜¯é†‰äº†ã€‚
soï¼Œé—ªé€€æµç¨‹ï¼šæ²™ç›’è·¯å¾„ä¸å˜ -> è§†é¢‘æ–‡ä»¶é‡å -> å­˜å‚¨å¤±è´¥ -> assert() -> é—ªé€€

æœ€åŽä¸€ä¸ªé—®é¢˜ï¼Œ__AVAssetExportSession__çœŸçš„æ— æ³•è¦†ç›–å·²å­˜åœ¨çš„åŒåæ–‡ä»¶å—ï¼Ÿæ˜¯çš„ï¼Œ[å®˜æ–¹è®²è§£](https://developer.apple.com/library/ios/documentation/AudioVideo/Conceptual/AVFoundationPG/Articles/01_UsingAssets.html)ï¼š
>The export will fail if you try to overwrite an existing file, or write a file outside of the applicationâ€™s sandbox. It may also fail if:
+ There is an incoming phone call
+ Your application is in the background and another application starts playback
In these situations, you should typically inform the user that the export failed, then allow the user to restart the export.